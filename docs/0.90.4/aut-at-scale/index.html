<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>The Toolkit at Scale · Archives Unleashed Toolkit</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="As your collections grow, you may need to provide more resources, and adjust"/><meta name="docsearch:version" content="0.90.4"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="The Toolkit at Scale · Archives Unleashed Toolkit"/><meta property="og:type" content="website"/><meta property="og:url" content="https://archivesunleashed.github.io/"/><meta property="og:description" content="As your collections grow, you may need to provide more resources, and adjust"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-2879197-28', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/favicon.ico" alt="Archives Unleashed Toolkit"/><h2 class="headerTitleWithLogo">Archives Unleashed Toolkit</h2></a><a href="/versions"><h3>0.90.4</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/0.90.4/home" target="_self">Docs</a></li><li class=""><a href="https://archivesunleashed.org" target="_self">Project</a></li><li class=""><a href="https://github.com/archivesunleashed/aut" target="_self">GitHub</a></li><li class=""><a href="https://news.archivesunleashed.org/" target="_self">News</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Getting Started</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Home</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.90.4/home">The Toolkit</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Getting Started</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.90.4/dependencies">Dependencies</a></li><li class="navListItem"><a class="navItem" href="/docs/0.90.4/usage">Usage</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/0.90.4/aut-at-scale">The Toolkit at Scale</a></li><li class="navListItem"><a class="navItem" href="/docs/0.90.4/dataframe-schemas">DataFrame Schemas</a></li><li class="navListItem"><a class="navItem" href="/docs/0.90.4/toolkit-walkthrough">Toolkit Walkthrough</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Generating Results</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.90.4/collection-analysis">Collection Analysis</a></li><li class="navListItem"><a class="navItem" href="/docs/0.90.4/text-analysis">Text Analysis</a></li><li class="navListItem"><a class="navItem" href="/docs/0.90.4/link-analysis">Link Analysis</a></li><li class="navListItem"><a class="navItem" href="/docs/0.90.4/image-analysis">Image Analysis</a></li><li class="navListItem"><a class="navItem" href="/docs/0.90.4/binary-analysis">Binary Analysis</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Filtering Results</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.90.4/filters-rdd">RDD Filters</a></li><li class="navListItem"><a class="navItem" href="/docs/0.90.4/filters-df">DataFrame Filters</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Standard Derivatives</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.90.4/aut-spark-submit-app">The Toolkit with spark-submit</a></li><li class="navListItem"><a class="navItem" href="/docs/0.90.4/auk-derivatives">AU Cloud Scholarly Derivatives</a></li><li class="navListItem"><a class="navItem" href="/docs/0.90.4/extract-binary-info">Extract Binary Info</a></li><li class="navListItem"><a class="navItem" href="/docs/0.90.4/extract-binary">Extract Binaries to Disk</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">What to do with Results</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.90.4/df-results">DataFrame Results</a></li><li class="navListItem"><a class="navItem" href="/docs/0.90.4/rdd-results">RDD Results</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">The Toolkit at Scale</h1></header><article><div><span><p>As your collections grow, you may need to provide more resources, and adjust
Apache Spark configuration options. Apache Spark has great
<a href="https://spark.apache.org/docs/latest/configuration.html">Configuration</a> and
<a href="https://spark.apache.org/docs/latest/tuning.html">Tuning</a> guides that are
worth checking out. If you're not sure where to start with scaling, join us in
<a href="slack.archivesunleashed.org">Slack</a> in the <code>#aut</code> channel, and we might be
able to provide some guidance.</p>
<h2><a class="anchor" aria-hidden="true" id="a-note-on-memory-and-cores"></a><a href="#a-note-on-memory-and-cores" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A Note on Memory and Cores</h2>
<p>As your datasets grow, you may need to provide more memory to Apache Spark.
You'll know this if you get an error saying that you have run out of &quot;Java Heap
Space.&quot;</p>
<p>You can add a
<a href="https://spark.apache.org/docs/latest/configuration.html">configuration</a> option
for adjusting available memory like so:</p>
<pre><code class="hljs css language-shell">spark-shell --driver-memory 4G --jars /path/to/aut-0.80.0-fatjar.jar
</code></pre>
<p>In the above case, you give Apache Spark 4GB of memory to execute the program.</p>
<p>In some other cases, despite giving AUT sufficient memory, you may still
encounter Java Heap Space issues. In those cases, it is worth trying to lower
the number of worker threads. When running locally (i.e. on a single laptop,
desktop, or server), by default AUT runs a number of threads equivalent to the
number of cores in your machine.</p>
<p>On a 16-core machine, you may want to drop to 12 cores if you are having memory
issues. This will increase stability but decrease performance a bit.</p>
<p>You can do so like this (the example is using 12 threads on a 16-core machine):</p>
<pre><code class="hljs css language-shell">spark-shell --master local[12] --driver-memory 4G --jars /path/to/aut-0.80.0-fatjar.jar
</code></pre>
<p>If you continue to have errors, look at your output and logs. They will usually
point you in the right direction. For instance, you may also need to increase
the network timeout value. Once in a while, AUT might get stuck on an odd
record and take longer than normal to process it. The <code>--conf spark.network.timeout=10000000</code> will ensure that AUT continues to work on
material, although it may take a while to process. This command then works:</p>
<pre><code class="hljs css language-shell">spark-shell --master local[12] --driver-memory 90G --conf spark.network.timeout=10000000 --jars /path/to/aut-0.80.0-fatjar.jar
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="reading-data-from-aws-s3"></a><a href="#reading-data-from-aws-s3" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reading Data from AWS S3</h2>
<p>We also support loading data stored in <a href="https://aws.amazon.com/s3/">Amazon S3</a>.
This advanced functionality requires that you provide Spark shell with your AWS
Access Key and AWS Secret Key, which you will get when creating your AWS
credentials (<a href="https://aws.amazon.com/blogs/security/wheres-my-secret-access-key/">read more
here</a>).</p>
<p>This script, for example, will find the top ten domains from a set of WARCs
found in an s3 bucket.</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> io.archivesunleashed._
<span class="hljs-keyword">import</span> io.archivesunleashed.matchbox._

sc.hadoopConfiguration.set(<span class="hljs-string">"fs.s3a.access.key"</span>, <span class="hljs-string">"&lt;my-access-key&gt;"</span>)
sc.hadoopConfiguration.set(<span class="hljs-string">"fs.s3a.secret.key"</span>, <span class="hljs-string">"&lt;my-secret-key&gt;"</span>)

<span class="hljs-type">RecordLoader</span>.loadArchives(<span class="hljs-string">"s3a://&lt;my-bucket&gt;/*.gz"</span>, sc)
  .keepValidPages()
  .map(r =&gt; <span class="hljs-type">ExtractDomain</span>(r.getUrl))
  .countItems()
  .take(<span class="hljs-number">10</span>)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="reading-data-from-an-s3-like-endpoint"></a><a href="#reading-data-from-an-s3-like-endpoint" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reading Data from an S3-like Endpoint</h3>
<p>We also support loading data stored in an Amazon S3-like system such as <a href="https://docs.ceph.com/docs/master/rados/">Ceph
RADOS</a>. Similar to the above example,
you'll need an access key and secret, and additionally, you'll need to define
your endpoint.</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> io.archivesunleashed._
<span class="hljs-keyword">import</span> io.archivesunleashed.matchbox._

sc.hadoopConfiguration.set(<span class="hljs-string">"fs.s3a.access.key"</span>, <span class="hljs-string">"&lt;my-access-key&gt;"</span>)
sc.hadoopConfiguration.set(<span class="hljs-string">"fs.s3a.secret.key"</span>, <span class="hljs-string">"&lt;my-secret-key&gt;"</span>)
sc.hadoopConfiguration.set(<span class="hljs-string">"fs.s3a.endpoint"</span>, <span class="hljs-string">"&lt;my-end-point&gt;"</span>)

<span class="hljs-type">RecordLoader</span>.loadArchives(<span class="hljs-string">"s3a://&lt;my-bucket&gt;/*.gz"</span>, sc)
  .keepValidPages()
  .map(r =&gt; <span class="hljs-type">ExtractDomain</span>(r.getUrl))
  .countItems()
  .take(<span class="hljs-number">10</span>)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="troubleshooting-s3"></a><a href="#troubleshooting-s3" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Troubleshooting S3</h3>
<p>If you run into this <code>AmazonHttpClient</code> timeout error:</p>
<pre><code class="hljs css language-shell">19/10/24 11:12:51 INFO AmazonHttpClient: Unable to execute HTTP request: Timeout waiting for connection from pool
org.apache.http.conn.ConnectionPoolTimeoutException: Timeout waiting for connection from pool
  at org.apache.http.impl.conn.PoolingClientConnectionManager.leaseConnection(PoolingClientConnectionManager.java:231)
  at org.apache.http.impl.conn.PoolingClientConnectionManager$1.getConnection(PoolingClientConnectionManager.java:200)
  at sun.reflect.GeneratedMethodAccessor7.invoke(Unknown Source)
  at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
  at java.lang.reflect.Method.invoke(Method.java:498)
  at com.amazonaws.http.conn.ClientConnectionRequestFactory$Handler.invoke(ClientConnectionRequestFactory.java:70)
</code></pre>
<p>You can add the following two configuration lines to your script:</p>
<pre><code class="hljs css language-scala">sc.hadoopConfiguration.set(<span class="hljs-string">"fs.s3a.impl"</span>, <span class="hljs-string">"org.apache.hadoop.fs.s3a.S3AFileSystem"</span>)
sc.hadoopConfiguration.setInt(<span class="hljs-string">"fs.s3a.connection.maximum"</span>, <span class="hljs-number">100</span>)
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/0.90.4/usage"><span class="arrow-prev">← </span><span>Usage</span></a><a class="docs-next button" href="/docs/0.90.4/dataframe-schemas"><span class="function-name-prevnext">DataFrame Schemas</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#a-note-on-memory-and-cores">A Note on Memory and Cores</a></li><li><a href="#reading-data-from-aws-s3">Reading Data from AWS S3</a><ul class="toc-headings"><li><a href="#reading-data-from-an-s3-like-endpoint">Reading Data from an S3-like Endpoint</a></li><li><a href="#troubleshooting-s3">Troubleshooting S3</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/favicon.ico" alt="Archives Unleashed Toolkit" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/dependencies">Getting Started</a><a href="/docs/collection-analysis">Generating Results</a><a href="/docs/filters-rdd">Filtering results</a><a href="/docs/aut-spark-submit-app">Standard Derivatives</a><a href="/docs/df-results">What to do with Results</a></div><div><h5>Community</h5><a href="https://archivesunleashed.org/get-involved/#newsletter-subscription" target="_blank">Newsletter</a><a href="http://slack.archivesunleashed.org/">Slack</a><a href="https://archivesunleashed.org/events/">Events</a><a href="https://zenodo.org/communities/wahr/">Datasets</a></div><div><h5>More</h5><a href="https://news.archivesunleashed.org/">Project News</a><a href="https://github.com/">GitHub</a><a href="https://twitter.com/unleasharchives" target="_blank">Twitter</a><a href="https://www.youtube.com/channel/UC4Sq0Xi6UWhYK2VbmAzFhAw" target="_blank">YouTube</a></div></section><section class="sitemap"><img alt="Andrew W. Mellon Foundation" class="footer_img" src="/img/mellon.svg"/><img alt="University of Waterloo" class="footer_img" src="/img/waterloo.png"/><img alt="York University" class="footer_img" src="/img/york.png"/></section><section class="copyright">CC BY 2.0 2023 Archives Unleashed Project</section></footer></div></body></html>